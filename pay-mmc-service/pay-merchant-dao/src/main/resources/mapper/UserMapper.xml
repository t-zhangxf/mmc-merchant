<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pay.merchant.mapper.UserMapper">
    <resultMap id="BaseResultMap" type="com.pay.merchant.entity.User">
        <id column="user_no" property="userNo" jdbcType="VARCHAR"/>
        <id column="email" property="email" jdbcType="VARCHAR"/>
        <id column="creator" property="creator" jdbcType="VARCHAR"/>
        <id column="identity_type" property="identityType" jdbcType="VARCHAR"/>
        <id column="identifier" property="identifier" jdbcType="VARCHAR"/>
        <id column="credential" property="credential" jdbcType="VARCHAR"/>
        <id column="user_status" property="userStatus" jdbcType="VARCHAR"/>
        <id column="active_status" property="activeStatus" jdbcType="VARCHAR"/>
    </resultMap>
    <sql id="Base_Column_List">
        tla.user_no,tla.identity_type,tla.identifier,tla.credential,tu.active_status,tu.creator,tu.email
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>
        from sys_user
        where is_deleted=0 and id = #{id,jdbcType=VARCHAR}
    </select>
    <select id="selectUseInfoByCondition" resultMap="BaseResultMap" parameterType="com.pay.common.entity.vo.UserVo">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tb_user_login_auths tla,tb_users tu
        WHERE tla.user_no=tu.user_no
        AND tla.is_deleted=0
        AND tu.is_deleted=0
        <if test="userNo != null">
            AND tla.user_no =#{userNo,jdbcType=VARCHAR}
        </if>
        <if test="credential != null">
            AND tla.credential = #{credential,jdbcType=VARCHAR}
        </if>
        <if test="userStatus != null">
            AND tu.user_status = #{userStatus,jdbcType=VARCHAR}
        </if>
        <if test="identityType != null">
            AND tla.identity_type = #{identityType,jdbcType=VARCHAR}
        </if>
        <if test="identifier != null">
            AND tla.identifier = #{identifier,jdbcType=VARCHAR}
        </if>
        <if test="email != null">
            AND tu.email = #{email,jdbcType=VARCHAR}
        </if>
        <if test="activeStatus != null">
            AND tu.active_status = #{activeStatus,jdbcType=TINYINT}
        </if>
    </select>
    <insert id="insertUser" parameterType="com.pay.merchant.entity.UserBind">
      insert into tb_users
       (user_no,email,creator,modifier)
        values
      ( #{userNo,jdbcType=VARCHAR},#{email,jdbcType=VARCHAR},#{creator,jdbcType=VARCHAR},#{modifier,jdbcType=VARCHAR})
    </insert>
    <insert id="insertBind" parameterType="com.pay.merchant.entity.UserBind">
      insert into tb_user_merc_binding
       (user_no,user_type,merc_id,status,bus_cnl,creator,modifier)
        values
       (#{userNo,jdbcType=VARCHAR},#{userType,jdbcType=VARCHAR},#{merChantId,jdbcType=VARCHAR},#{status,jdbcType=VARCHAR},#{busCnl,jdbcType=VARCHAR},#{creator,jdbcType=VARCHAR},#{modifier,jdbcType=VARCHAR})
    </insert>
    <select id="selectRoleBuUserVo" parameterType="com.pay.merchant.entity.UserBind" resultType="com.pay.merchant.entity.Role">
        select * from  tb_role
        where 1=1 and is_deleted=0
        <if test="roleNumber != null">
            AND role_number = #{roleNumber,jdbcType=VARCHAR}
        </if>
    </select>
    <resultMap id="BaseUserInfoResultMap" type="com.pay.merchant.entity.UserBind">
        <id column="user_no" property="userNo" jdbcType="VARCHAR"/>
        <id column="mobile" property="mobile" jdbcType="VARCHAR"/>
        <id column="email" property="email" jdbcType="VARCHAR"/>
    </resultMap>
    <select id="findUserBindInfoByUserMerchant" parameterType="com.pay.merchant.entity.UserBind"
            resultMap="BaseUserInfoResultMap">
        SELECT DISTINCT tu.user_no,tu.mobile,tu.email FROM
        tb_users tu,tb_user_login_auths tul,tb_user_merc_binding tumb
        WHERE   tu.user_no=tul.user_no  AND tul.user_no=tumb.user_no
        AND tu.is_deleted=0     AND tul.is_deleted=0
        AND tumb.is_deleted=0   AND tu.user_status=0
        <if test="email != null">
            AND tu.email = #{email,jdbcType=VARCHAR}
        </if>
        <if test="merChantId != null">
            AND tumb.merc_id =#{merChantId,jdbcType=VARCHAR}
        </if>
        <if test="merChantNull != null">
            AND (tumb.merc_id is NULL or tumb.status=1)
        </if>
    </select>
    <resultMap id="BaseRoleResultMap" type="com.pay.merchant.entity.Role">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <id column="name" property="name" jdbcType="VARCHAR"/>
        <id column="type" property="type" jdbcType="VARCHAR"/>
        <id column="role_number" property="roleNumber" jdbcType="VARCHAR"/>
    </resultMap>
    <select id="selectRoleByUserNo" parameterType="com.pay.common.entity.vo.UserVo" resultMap="BaseRoleResultMap">
         SELECT  tr.id,tr.name,tr.type,tr.role_number  FROM  tb_role tr
         WHERE 1=1 AND  tr.is_deleted=0
        <if test="userNo != null">
            AND tr.name =#{userNo,jdbcType=VARCHAR}
        </if>
    </select>
    <delete id="deleteUserRoleByRoleId" parameterType="com.pay.merchant.entity.UserBind">
       delete from tb_user_role where  role_id=#{roleId,jdbcType=VARCHAR} and  user_no=#{userNo,jdbcType=VARCHAR} and merc_id=#{merChantId,jdbcType=VARCHAR}
    </delete>
    <delete id="deleteRolePermissionByRoleId" parameterType="com.pay.merchant.entity.UserBind">
       delete from tb_role_permission where  role_id=#{roleId,jdbcType=VARCHAR}
    </delete>
    <update id="updateUserMerchantBindingByUserNo" parameterType="com.pay.merchant.entity.UserBind">
           update tb_user_merc_binding set status=#{status,jdbcType=VARCHAR},is_deleted=#{isDeleted,jdbcType=TINYINT}  where user_no=#{userNo,jdbcType=VARCHAR} and merc_id=#{merChantId,jdbcType=VARCHAR}
    </update>
    <update id="deleteUserMerchantBindingByUserNo" parameterType="com.pay.merchant.entity.UserBind">
           delete from tb_user_merc_binding  where user_no=#{userNo,jdbcType=VARCHAR} and merc_id=#{merChantId,jdbcType=VARCHAR}
    </update>
    <resultMap id="BaseMerchantResultMap" type="com.pay.merchant.entity.UserMercBinding">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <id column="user_no" property="userNo" jdbcType="VARCHAR"/>
        <id column="merc_id" property="mercId" jdbcType="VARCHAR"/>
    </resultMap>
    <select id="selectUserMerchantBindingByUserNo" parameterType="com.pay.merchant.entity.UserBind" resultMap="BaseMerchantResultMap" >
      select id,user_no,merc_id  from  tb_user_merc_binding  where user_no=#{userNo,jdbcType=VARCHAR} and merc_id=#{merChantId,jdbcType=VARCHAR}
    </select>

    <select id="findUserMerchantInfoByEmail" parameterType="com.pay.merchant.entity.UserBind" resultMap="BaseMerchantResultMap">
      SELECT mb.merc_id,mb.user_no FROM tb_users tu,tb_user_login_auths tla,tb_user_merc_binding mb
      WHERE     tu.user_no=tla.user_no   AND  tla.user_no=mb.user_no
                AND  tu.is_deleted=0     AND  tla.is_deleted=0
                AND  mb.is_deleted=0     AND tu.user_status=0
                and  tla.identity_type=0 AND  mb.status=1
          <if test="email != null">
            AND tu.email = #{email,jdbcType=VARCHAR}
          </if>
    </select>
    <update id="updateUserStatusByUserNo" parameterType="com.pay.merchant.entity.UserBind">
        update tb_users tu set tu.active_status=#{acStatus,jdbcType=TINYINT} where tu.user_no =#{userNo,jdbcType=VARCHAR} and user_status=0
    </update>
</mapper>